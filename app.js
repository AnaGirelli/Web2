import sequelize from './mvc/config/database.js';
import path from 'path';
import express from 'express';
import route from './mvc/routes/route.js'; 
import session from 'express-session';

// Definir __dirname para Módulos ES (import/export)
import { fileURLToPath } from 'url';
import { dirname } from 'path';
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

//Instanciar o aplicativo express
const app = express();
const port = 3000;

//Uso de seções de usuário
app.use(session({secret:'textosecreto',
    resave: false, // Boa prática: evita salvar se não houver modificação
    saveUninitialized: false, // Boa prática: evita criar sessão para quem não logou
    cookie:{maxAge: 30*60*1000}})); // Armazena a sessão por 30 minutos

// Define o EJS como motor de view padrão
app.set('view engine', 'ejs');
app.set('views', 'mvc/views');
app.use(express.static(path.join(__dirname, 'public')));

// Middlewares
app.use(express.json()); //interpreta JSON no corpo das requisições
app.use(express.urlencoded({ extended: true })); // Utilizado para interpretar dados de formulário (POST)
app.use('/', route); //Usa as rotas do MVC (as definidas em mvc/routes/route.js)

//Testar a conexão com o banco de dados
(async () => {
  try {
    await sequelize.authenticate();
    console.log('✅ Conexão com o banco bem-sucedida');
  } catch (error) {
    console.error('❌ Erro ao conectar com o banco:', error);
  }
})();

app.listen(port, () => {
    console.log(`Servidor em execução no endereço http://localhost:${port}`);
});
